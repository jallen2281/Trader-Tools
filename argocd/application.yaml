apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: trader-tools
  namespace: argocd
  # Finalizer ensures cascading delete
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  # Labels for organization
  labels:
    app: trader-tools
    environment: production
spec:
  # The project to deploy into (default is 'default')
  project: default
  
  # Source repository configuration
  source:
    # REPLACE WITH YOUR GIT REPOSITORY URL
    repoURL: https://github.com/jallen2281/Trader-Tools.git
    targetRevision: master  #Branch, tag, or commit SHA
    path: helm/trader-tools  # Path to Helm chart
    
    # Helm-specific configuration
    helm:
      # Release name
      releaseName: trader-tools
      
      # Values file overrides (optional)
      valueFiles:
        - values.yaml
      
      # Inline values (override values.yaml)
      values: |
        # Image configuration for GHCR
        image:
          repository: ghcr.io/jallen2281/trader-tools
          pullPolicy: Always
          tag: "latest"
        
        # Resource limits for production
        resources:
          limits:
            cpu: 2000m
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 1Gi
        
        # Storage configuration
        persistence:
          enabled: true
          size: 10Gi
          storageClass: ceph-rbd
        
        # Ingress configuration
        ingress:
          enabled: true
          className: "public"
          annotations:
            cert-manager.io/cluster-issuer: "letsencrypt-prod"
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
          hosts:
            - host: tradertools.kegbot.net
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: trader-tools-tls
              hosts:
                - tradertools.kegbot.net
        
        # Auto-scaling
        autoscaling:
          enabled: true
          minReplicas: 2
          maxReplicas: 10
          targetCPUUtilizationPercentage: 70
          targetMemoryUtilizationPercentage: 80
        
        # SECRETS - Pass via Helm values
        # IMPORTANT: Helm will create the secret automatically
#        secrets:
#          secretKey: "your-secret-key-here-change-me"  # CHANGE THIS!
#          googleClientId: "your-google-client-id"  # CHANGE THIS!
#          googleClientSecret: "your-google-client-secret"  # CHANGE THIS!
#          databaseUrl: "sqlite:////data/financial_analysis.db"
#          ollamaBaseUrl: "http://localhost:11434"
      
      # Skip CRDs (if any)
      skipCrds: false
      
  # Destination cluster and namespace
  destination:
    # In-cluster deployment
    server: https://kubernetes.default.svc
    namespace: trader-tools
  
  # Sync policy
  syncPolicy:
    # Automated sync policy
    automated:
      # Automatically apply changes from Git
      prune: true  # Delete resources not in Git
      selfHeal: true  # Sync when cluster state drifts
      allowEmpty: false  # Don't sync if no resources
    
    # Sync options
    syncOptions:
      - CreateNamespace=true  # Auto-create namespace
      - PrunePropagationPolicy=foreground  # Delete dependents first
      - PruneLast=true  # Prune after other resources are synced
      - ApplyOutOfSyncOnly=true  # Only sync out-of-sync resources
      - RespectIgnoreDifferences=true  # Respect ignore differences
    
    # Retry policy for failed syncs
    retry:
      limit: 5  # Number of retry attempts
      backoff:
        duration: 5s  # Initial backoff duration
        factor: 2  # Backoff factor
        maxDuration: 3m  # Max backoff duration
  
  # Ignore differences for certain fields
  ignoreDifferences:
    # Ignore replicas if HPA is managing it
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
    # Ignore certain annotations
    - group: "*"
      kind: "*"
      managedFieldsManagers:
        - kube-controller-manager
  
  # Application health and sync status
  # (Optional) Custom health checks
  # info:
  #   - name: url
  #     value: http://trading.local
